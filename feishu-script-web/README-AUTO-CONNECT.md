# 飞书短链接批量扩展工具

## 功能概述

全新的单页面短链接批量扩展工具，支持自动获取飞书多维表格信息，一键完成短链接到实际链接的批量转换。

## 主要特性

- **自动连接**: 自动获取飞书多维表格的 `appToken` 和 `tableId`
- **智能匹配**: 支持自定义短链接域名匹配规则
- **实时预览**: 实时显示匹配的短链接数量和内容
- **批量处理**: 一键批量扩展所有匹配的短链接
- **灵活替换**: 支持原列替换或新增列模式

## 工作原理

### 1. 飞书插件环境
当在飞书多维表格中作为插件运行时：
- 自动检测飞书环境
- 使用 `@lark-base-open/js-sdk` 的 `bitable.base.getSelection()` API
- 自动获取当前选中表格的 `baseId` 和 `tableId`

### 2. 非飞书环境
当不在飞书插件环境中时：
- 尝试从URL参数获取 `app_token` 和 `table_id`
- 提供手动输入选项作为备用方案

## 使用方式

### 作为飞书插件使用
1. 在飞书多维表格中点击“插件”
2. 添加自定义插件，输入部署地址
3. 插件自动获取当前表格信息并加载数据
4. 设置短链接匹配规则（可选）
5. 选择包含短链接的列
6. 选择替换模式（原列替换或新增列）
7. 点击“开始扩展短链接”按钮
8. 等待处理完成，点击“写回”按钮

### 通过URL参数使用
访问URL时添加参数：
```
https://your-domain.com/scripts/url-expander?app_token=YOUR_APP_TOKEN&table_id=YOUR_TABLE_ID
```

### 手动输入（备用）
如果自动获取失败，可以展开"手动输入表格信息"选项，手动填入：
- App Token (多维表格的应用令牌)
- Table ID (数据表ID)

## 技术实现

### 前端组件
- `composables/useFeishu.ts`: 飞书SDK集成
- `pages/scripts/url-expander.vue`: 更新的UI界面

### 后端API
- `server/api/feishu/fields.post.ts`: 获取表格字段
- `server/api/feishu/records.post.ts`: 获取表格记录

### 关键功能
1. **环境检测**: 自动识别是否在飞书插件环境
2. **SDK集成**: 使用飞书JS SDK获取表格信息
3. **降级处理**: 提供多种获取方式的备用方案
4. **错误处理**: 完善的错误提示和处理机制

## 用户体验改进

### 之前的流程（分步骤界面）
1. 手动输入 app_token 和 table_id
2. 点击加载表格数据
3. 选择包含短链接的列
4. 点击预览数据
5. 配置替换模式
6. 点击开始处理
7. 等待处理完成
8. 点击写回数据

### 现在的流程（单页面界面）
1. 打开页面，自动获取表格信息并加载数据
2. 设置短链接匹配规则（可选）
3. 选择包含短链接的列，自动显示匹配结果
4. 选择替换模式
5. 一键开始处理，实时显示进度
6. 处理完成后一键写回

## 兼容性

- ✅ 飞书多维表格插件环境
- ✅ 带URL参数的直接访问
- ✅ 手动输入模式（向后兼容）
- ✅ 非飞书环境的API调用

## 错误处理

系统会在以下情况提供友好的错误提示：
- 不在飞书环境且无URL参数
- 飞书SDK初始化失败
- 网络请求失败
- 权限不足

## 开发说明

如需扩展此功能，请参考：
1. `useFeishu` composable 的实现
2. 飞书开放平台API文档
3. `@lark-base-open/js-sdk` 文档
