const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-BjkkHUNJ.js","./index-Drx1IuvM.js","./index-30Z6U7Xn.css"])))=>i.map(i=>d[i]);
import{o as we,r as O,a as f,_ as me,d as xe,b as _e,c as l,e as t,u as Q,t as k,f as M,w as B,v as ke,F as ee,g as te,h as se,n as H,i as ae,j as Ie,k as J,l as Se,m as Ue,p as N,E as Y,q as Ce,s as o,x as Ee}from"./index-Drx1IuvM.js";import{a as Fe,f as Te}from"./client-6-I-OaSH.js";const G=w=>w instanceof Error?w.message:typeof w=="string"?w:"æœªçŸ¥é”™è¯¯",j=w=>w instanceof Error&&w.name==="AbortError",Me=()=>{const w=f(!1),K=f(null),C=f(!1),c=f(null),E=f([]),I=f(!1),P=()=>{const n=new AbortController;return E.value.push(n),n},R=()=>{E.value.forEach(n=>n.abort()),E.value=[]},m=()=>{if(typeof window>"u")return!1;const n=window.self!==window.top,i=window.location.search.includes("app_token")||window.location.search.includes("table_id");return w.value=n||i,w.value},b=async()=>{if(typeof window>"u"||I.value)return null;const n=P();try{const{bitable:i}=await me(async()=>{const{bitable:g}=await import("./index-BjkkHUNJ.js").then(T=>T.i);return{bitable:g}},__vite__mapDeps([0,1,2]),import.meta.url);if(n.signal.aborted||I.value)return null;if(!i)throw new Error("é£ä¹¦SDKä¸å¯ç”¨");return i}catch(i){return j(i)||(console.warn("é£ä¹¦SDKåˆå§‹åŒ–å¤±è´¥:",i),c.value="é£ä¹¦SDKåˆå§‹åŒ–å¤±è´¥"),null}},A=async()=>{C.value=!0,c.value=null;try{const n=await b();if(!n)throw new Error("é£ä¹¦SDKä¸å¯ç”¨");const i=await n.base.getSelection();return K.value=i,i}catch(n){return j(n)||(console.error("è·å–é€‰æ‹©ä¿¡æ¯å¤±è´¥:",n),c.value=G(n)),null}finally{C.value=!1}},V=async n=>{C.value=!0,c.value=null;try{const i=await b();if(!i)throw new Error("é£ä¹¦SDKä¸å¯ç”¨");const T=await(n?await i.base.getTable(n):await i.base.getActiveTable()).getFieldList();return await Promise.all(T.map(async $=>{const F=await $.getMeta();return{fieldId:F.id,fieldName:F.name,fieldType:String(F.type)}}))}catch(i){return j(i)?[]:(console.error("è·å–è¡¨æ ¼å­—æ®µå¤±è´¥:",i),c.value=G(i),[])}finally{C.value=!1}},h=async(n,i)=>{C.value=!0,c.value=null;try{const g=await b();if(!g)throw new Error("é£ä¹¦SDKä¸å¯ç”¨");return(await(n?await g.base.getTable(n):await g.base.getActiveTable()).getRecords({pageSize:100,viewId:i})).records.map(F=>({recordId:F.recordId,fields:F.fields}))}catch(g){return j(g)?[]:(console.error("è·å–è¡¨æ ¼è®°å½•å¤±è´¥:",g),c.value=G(g),[])}finally{C.value=!1}},D=()=>{if(typeof window>"u")return{baseId:null,tableId:null};const n=new URLSearchParams(window.location.search);return{baseId:n.get("app_token")||n.get("base_id"),tableId:n.get("table_id")}},L=async()=>{if(!m()){const i=D();return i.baseId&&i.tableId?{baseId:i.baseId,tableId:i.tableId,source:"url"}:(c.value="è¯·åœ¨é£ä¹¦å¤šç»´è¡¨æ ¼ç¯å¢ƒä¸­ä½¿ç”¨æ­¤åŠŸèƒ½",null)}const n=await A();return n&&n.baseId&&n.tableId?{baseId:n.baseId,tableId:n.tableId,source:"sdk"}:(c.value="æ— æ³•è·å–è¡¨æ ¼ä¿¡æ¯ï¼Œè¯·ç¡®ä¿å·²é€‰æ‹©è¡¨æ ¼",null)};return we(()=>{I.value=!0,R()}),{isFeishuEnv:O(w),selection:O(K),loading:O(C),error:O(c),checkFeishuEnvironment:m,initFeishuSDK:b,getCurrentSelection:A,getTableFields:V,getTableRecords:h,getIdsFromUrl:D,autoGetTableInfo:L}},re={expandBatch(w){return Fe.post("/url-expand/batch",{urls:w})}},Re={class:"url-expander"},De={class:"status-bar"},Ae={key:0,class:"status-badge status-info"},Le={key:1,class:"status-badge status-success"},ze={key:2,class:"status-badge status-error"},Pe={key:0,class:"main"},Ve={class:"panel config-panel"},Be={class:"panel-body"},Ne={class:"form-row"},Ke={class:"form-group"},$e=["value"],Oe={class:"form-group"},je={class:"form-row"},qe={class:"form-group"},He={class:"radio-group compact"},Je={key:0,class:"form-group"},Ye={key:0,class:"panel preview-panel"},Ge={class:"panel-header"},We={class:"panel-badge"},Xe={class:"panel-body"},Ze={class:"data-table"},Qe={class:"table-body"},et={class:"td",style:{width:"40px"}},tt=["title"],st={class:"url-text"},at={class:"td",style:{width:"70px"}},rt={key:0,class:"tag tag-success"},nt={key:1,class:"tag tag-processing"},lt={key:2,class:"tag tag-error"},ot={key:3,class:"tag tag-pending"},it=["title"],dt={key:0,class:"url-text success"},ct={key:1,class:"url-text error"},ut={key:2,class:"url-text placeholder"},pt={class:"panel action-panel"},ft={class:"panel-body"},vt={class:"action-bar"},gt=["disabled"],ht={key:0,class:"btn-spinner"},bt={key:1,width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},yt=["disabled"],wt={key:0,class:"btn-spinner"},mt={key:1,width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},xt=["disabled"],_t={key:0,class:"btn-spinner"},kt={key:1,width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},It={key:0,class:"progress-wrapper"},St={class:"progress-bar"},Ut={class:"progress-meta"},Ct={key:0,class:"progress-result"},Et={key:1,class:"inline-alert"},ne=10,Ft=1e3,Tt=xe({__name:"UrlExpanderView",setup(w){const K=Ce(),C=f(!1),c=f(!1),E=Me(),I=Ue({appToken:"",tableId:""}),P=f([]),R=f([]),m=f(""),b=f("newColumn"),A=f("è§£æåé“¾æ¥"),V=f(""),h=f([]),D=f(0),L=f(0),n=f(0),i=f(0),g=f(!1),T=f(!1),q=N(()=>P.value.filter(s=>{const e=Number(s.fieldType);return[1,13].includes(e)})),$=N(()=>D.value===0?0:Math.round(L.value/D.value*100)),F=N(()=>h.value.filter(s=>!s.expanded&&s.error).length),le=N(()=>F.value>0),W=N(()=>!!m.value&&h.value.length>0&&!c.value);function oe(){K.push("/")}function ie(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function X(s){if(s==null)return"";if(typeof s=="string"||typeof s=="number")return String(s);if(Array.isArray(s)){if(s.length===0)return"";const e=s[0];return e&&typeof e=="object"?"text"in e?String(e.text):"link"in e?String(e.link):"url"in e?String(e.url):JSON.stringify(e):String(e)}return typeof s=="object"?"text"in s?String(s.text):"link"in s?String(s.link):"url"in s?String(s.url):JSON.stringify(s):String(s)}async function de(){E.checkFeishuEnvironment()&&await ce()}async function ce(){C.value=!0;try{const s=await E.initFeishuSDK();if(!s)throw new Error("é£ä¹¦SDKåˆå§‹åŒ–å¤±è´¥");const e=await s.base.getActiveTable(),a=await e.getFieldList(),r=[];for(const p of a){const v=await p.getMeta();r.push({fieldId:v.id,fieldName:v.name,fieldType:String(v.type)})}P.value=r;const d=await e.getMeta();I.tableId=d.id,I.appToken="current",await ue()}catch(s){console.error("åŠ è½½è¡¨æ ¼æ•°æ®å¤±è´¥:",s),P.value=[]}finally{C.value=!1}}async function ue(){if(I.tableId)try{const s=await E.getTableRecords(I.tableId);R.value=s.map(e=>{const a={recordId:e.recordId};for(const[r,d]of Object.entries(e.fields))a[r]=X(d);return a}),m.value&&await Z()}catch(s){console.error("åŠ è½½è®°å½•å¤±è´¥:",s),R.value=[]}}async function pe(){m.value&&R.value.length>0?await Z():h.value=[]}function fe(s,e){const a=[],r=/https?:\/\/[a-zA-Z0-9\-._~:/?#[\]@!$&'()*+,;=%]+/g,d=s.match(r)||[];for(let p of d)p=p.replace(/[ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€ï¼‰ã€‘ã€‹ã€ã€"']+$/,""),(e.length===0||e.some(u=>p.includes(u)))&&a.push(p);return a}async function Z(){if(!m.value||R.value.length===0){h.value=[];return}const s=V.value.split(",").map(a=>a.trim()).filter(a=>a.length>0),e=[];for(const a of R.value){const r=a[m.value];if(typeof r=="string"&&r.trim()){const d=r.trim(),p=fe(d,s);for(const v of p)e.push({recordId:a.recordId||"",originalUrl:v,processing:!1,expanded:!1,retryCount:0,maxRetries:ne})}}h.value=e}async function ve(s){const e=s.maxRetries||ne;for(let a=0;a<=e;a++){s.processing=!0,s.retryCount=a,a>0&&await new Promise(r=>setTimeout(r,Ft));try{const r=await re.expandBatch([s.originalUrl]);if(r.data.success&&r.data.results&&r.data.results[0]){const d=r.data.results[0];if(d.success&&d.expandedUrl){s.expandedUrl=d.expandedUrl,s.expanded=!0,s.error=void 0,n.value++;break}else{const p=d.error||"è§£æå¤±è´¥";if(a<e)continue;s.error=`${p} (é‡è¯•${e}æ¬¡åå¤±è´¥)`;break}}else{if(a<e)continue;s.error=`APIå“åº”æ ¼å¼é”™è¯¯ (é‡è¯•${e}æ¬¡åå¤±è´¥)`;break}}catch(r){const d=r instanceof Error?r.message:"ç½‘ç»œé”™è¯¯";s.error=d;break}}s.processing=!1,L.value++,!s.expanded&&!s.error&&(s.error="å¤„ç†å¼‚å¸¸")}async function ge(){if(W.value){c.value=!0,g.value=!1,D.value=h.value.length,L.value=0,n.value=0,i.value=0;try{const e=[];for(let a=0;a<h.value.length;a+=3)e.push(h.value.slice(a,a+3));await Promise.all(e.map(async a=>{await Promise.all(a.map(r=>ve(r)))})),g.value=!0}catch(s){console.error("å¤„ç†å¤±è´¥:",s)}finally{c.value=!1}}}async function he(){const s=h.value.filter(e=>!e.expanded&&e.error);if(s.length!==0){c.value=!0,g.value=!1;try{const a=[];for(let r=0;r<s.length;r+=3)a.push(s.slice(r,r+3));await Promise.all(a.map(async r=>{r.forEach(d=>{d.processing=!0,d.error=void 0});try{const d=r.map(v=>v.originalUrl),p=await re.expandBatch(d);p.data.success&&p.data.results?p.data.results.forEach((v,u)=>{const S=r[u];v.success&&v.expandedUrl?(S.expandedUrl=v.expandedUrl,S.expanded=!0):S.error=v.error||"é‡è¯•å¤±è´¥",S.processing=!1}):r.forEach(v=>{v.error="æ¥å£è¿”å›å¤±è´¥",v.processing=!1})}catch{r.forEach(p=>{p.error="è¯·æ±‚å¤±è´¥",p.processing=!1})}})),g.value=!0}catch(e){console.error("é‡è¯•å¤±è´¥:",e)}finally{c.value=!1}}}async function be(){T.value=!0;try{const s=await E.initFeishuSDK();if(!s)throw new Error("é£ä¹¦SDKåˆå§‹åŒ–å¤±è´¥");const e=await s.base.getActiveTable();let a;if(b.value==="newColumn"){const u=A.value||"è§£æåé“¾æ¥",S=await e.getFieldList(),x=[];for(const _ of S){const y=await _.getMeta();x.push({id:y.id,name:y.name,type:y.type,field:_})}let U=x.find(_=>_.name===u);if(U||(U=x.find(_=>{var y;return((y=_.name)==null?void 0:y.trim())===u.trim()})),U)a=U.id;else{let _=u,y=1;for(;x.some(ye=>ye.name===_);)y++,_=`${u}_${y}`;const z=await e.addField({type:1,name:_});a=z.id||z.fieldId,!a&&typeof z=="string"&&(a=z)}}else a=m.value;const r=[];if(b.value==="inplace"){const u=new Map;for(const x of R.value){const U=x.recordId,_=X(x[m.value]);u.set(U,_)}const S=new Set;for(const x of h.value.filter(U=>U.expanded&&U.expandedUrl)){if(S.has(x.recordId))continue;let U=u.get(x.recordId)||"";const _=h.value.filter(y=>y.recordId===x.recordId&&y.expanded&&y.expandedUrl);for(const y of _){const z=new RegExp(ie(y.originalUrl),"g");U=U.replace(z,y.expandedUrl)}r.push({recordId:x.recordId,fields:{[a]:U}}),S.add(x.recordId)}}else r.push(...h.value.filter(u=>u.expanded&&u.expandedUrl).map(u=>({recordId:u.recordId,fields:{[a]:u.expandedUrl}})));if(r.length===0)throw new Error("æ²¡æœ‰å¯å›å†™çš„æ•°æ®");const d=100;let p=0,v=0;for(let u=0;u<r.length;u+=d){const S=r.slice(u,u+d);try{await e.setRecords(S),p+=S.length}catch{v+=S.length}}v===0?Y.success(`å›å†™æˆåŠŸï¼å…± ${p} æ¡`):Y.warning(`å›å†™å®Œæˆï¼šæˆåŠŸ ${p} æ¡ï¼Œå¤±è´¥ ${v} æ¡`)}catch(s){console.error("å†™å›å¤±è´¥:",s),Y.error(`å†™å›å¤±è´¥: ${s instanceof Error?s.message:"æœªçŸ¥é”™è¯¯"}`)}finally{T.value=!1}}return _e(async()=>{Te(),await de()}),(s,e)=>(o(),l("div",Re,[t("header",{class:"header"},[t("button",{class:"back-btn",onClick:oe},[...e[5]||(e[5]=[t("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M19 12H5M12 19l-7-7 7-7"})],-1)])]),e[6]||(e[6]=t("h1",{class:"title"},"URL è§£æå™¨",-1)),e[7]||(e[7]=t("div",{class:"header-spacer"},null,-1))]),t("div",De,[Q(E).isFeishuEnv.value?I.appToken&&I.tableId?(o(),l("div",Le,[e[9]||(e[9]=t("span",{class:"status-dot"},null,-1)),t("span",null,"å·²è¿æ¥: "+k(I.tableId.slice(0,8))+"...",1)])):Q(E).error.value?(o(),l("div",ze,[...e[10]||(e[10]=[t("span",{class:"status-dot"},null,-1),t("span",null,"è¿æ¥å¤±è´¥",-1)])])):M("",!0):(o(),l("div",Ae,[...e[8]||(e[8]=[t("span",{class:"status-dot"},null,-1),t("span",null,"è¯·åœ¨é£ä¹¦ç¯å¢ƒä¸­ä½¿ç”¨",-1)])]))]),I.appToken&&I.tableId?(o(),l("main",Pe,[t("section",Ve,[e[20]||(e[20]=t("div",{class:"panel-header"},[t("span",{class:"panel-icon"},"âš™ï¸"),t("h2",{class:"panel-title"},"é…ç½®")],-1)),t("div",Be,[t("div",Ne,[t("div",Ke,[e[12]||(e[12]=t("label",{class:"form-label"},"çŸ­é“¾æ¥åˆ—",-1)),B(t("select",{"onUpdate:modelValue":e[0]||(e[0]=a=>m.value=a),class:"form-select",onChange:pe},[e[11]||(e[11]=t("option",{value:""},"é€‰æ‹©åˆ—",-1)),(o(!0),l(ee,null,te(q.value,a=>(o(),l("option",{key:a.fieldId,value:a.fieldId},k(a.fieldName),9,$e))),128))],544),[[ke,m.value]])]),t("div",Oe,[e[13]||(e[13]=t("label",{class:"form-label"},"åŒ¹é…è§„åˆ™",-1)),B(t("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>V.value=a),type:"text",class:"form-input",placeholder:"å¦‚: bit.ly, t.cn"},null,512),[[se,V.value]])])]),t("div",je,[t("div",qe,[e[18]||(e[18]=t("label",{class:"form-label"},"è¾“å‡ºæ¨¡å¼",-1)),t("div",He,[t("label",{class:H(["radio-item",{active:b.value==="inplace"}])},[B(t("input",{type:"radio","onUpdate:modelValue":e[2]||(e[2]=a=>b.value=a),value:"inplace"},null,512),[[ae,b.value]]),e[14]||(e[14]=t("span",{class:"radio-check"},null,-1)),e[15]||(e[15]=t("span",null,"åŸåˆ—æ›¿æ¢",-1))],2),t("label",{class:H(["radio-item",{active:b.value==="newColumn"}])},[B(t("input",{type:"radio","onUpdate:modelValue":e[3]||(e[3]=a=>b.value=a),value:"newColumn"},null,512),[[ae,b.value]]),e[16]||(e[16]=t("span",{class:"radio-check"},null,-1)),e[17]||(e[17]=t("span",null,"æ–°å¢åˆ—",-1))],2)])]),b.value==="newColumn"?(o(),l("div",Je,[e[19]||(e[19]=t("label",{class:"form-label"},"æ–°åˆ—åç§°",-1)),B(t("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>A.value=a),type:"text",class:"form-input",placeholder:"è§£æåé“¾æ¥"},null,512),[[se,A.value]])])):M("",!0)])])]),m.value&&h.value.length>0?(o(),l("section",Ye,[t("div",Ge,[e[21]||(e[21]=t("span",{class:"panel-icon"},"ğŸ“‹",-1)),e[22]||(e[22]=t("h2",{class:"panel-title"},"æ•°æ®é¢„è§ˆ",-1)),t("span",We,k(h.value.length)+" æ¡",1)]),t("div",Xe,[t("div",Ze,[e[24]||(e[24]=Ie('<div class="table-header" data-v-4f25baa6><div class="th" style="width:40px;" data-v-4f25baa6>#</div><div class="th" style="flex:1.5;" data-v-4f25baa6>åŸå§‹é“¾æ¥</div><div class="th" style="width:70px;" data-v-4f25baa6>çŠ¶æ€</div><div class="th" style="flex:1.5;" data-v-4f25baa6>è§£æç»“æœ</div></div>',1)),t("div",Qe,[(o(!0),l(ee,null,te(h.value,(a,r)=>(o(),l("div",{key:r,class:"table-row"},[t("div",et,k(r+1),1),t("div",{class:"td",style:{flex:"1.5"},title:a.originalUrl},[t("span",st,k(a.originalUrl),1)],8,tt),t("div",at,[a.expanded?(o(),l("span",rt,"æˆåŠŸ")):a.processing?(o(),l("span",nt,[...e[23]||(e[23]=[t("span",{class:"spinner"},null,-1)])])):a.error?(o(),l("span",lt,"å¤±è´¥")):(o(),l("span",ot,"å¾…å¤„ç†"))]),t("div",{class:"td",style:{flex:"1.5"},title:a.expandedUrl||a.error},[a.expandedUrl?(o(),l("span",dt,k(a.expandedUrl),1)):a.error?(o(),l("span",ct,k(a.error),1)):(o(),l("span",ut,"-"))],8,it)]))),128))])])])])):M("",!0),t("section",pt,[t("div",ft,[t("div",vt,[t("button",{class:"btn btn-primary",disabled:!W.value||c.value,onClick:ge},[c.value?(o(),l("span",ht)):(o(),l("svg",bt,[...e[25]||(e[25]=[t("path",{d:"M13 2L3 14h9l-1 8 10-12h-9l1-8z"},null,-1)])])),J(" "+k(c.value?"å¤„ç†ä¸­...":"å¼€å§‹è§£æ"),1)],8,gt),g.value?(o(),l("button",{key:0,class:"btn btn-success",disabled:T.value,onClick:be},[T.value?(o(),l("span",wt)):(o(),l("svg",mt,[...e[26]||(e[26]=[t("path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"},null,-1),t("polyline",{points:"17 21 17 13 7 13 7 21"},null,-1)])])),J(" "+k(b.value==="inplace"?"å†™å›åŸåˆ—":"åˆ›å»ºæ–°åˆ—"),1)],8,yt)):M("",!0),le.value?(o(),l("button",{key:1,class:"btn btn-warning",disabled:c.value,onClick:he},[c.value?(o(),l("span",_t)):(o(),l("svg",kt,[...e[27]||(e[27]=[t("polyline",{points:"23 4 23 10 17 10"},null,-1),t("path",{d:"M20.49 15a9 9 0 1 1-2.12-9.36L23 10"},null,-1)])])),J(" é‡è¯• ("+k(F.value)+") ",1)],8,xt)):M("",!0)]),c.value||g.value?(o(),l("div",It,[t("div",St,[t("div",{class:H(["progress-fill",{complete:g.value}]),style:Se({width:$.value+"%"})},null,6)]),t("div",Ut,[t("span",null,k(L.value)+" / "+k(D.value),1),g.value?(o(),l("span",Ct," æˆåŠŸ "+k(n.value)+" Â· å¤±è´¥ "+k(F.value),1)):M("",!0)])])):M("",!0),b.value==="inplace"&&m.value?(o(),l("div",Et,[...e[28]||(e[28]=[t("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[t("path",{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}),t("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),t("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})],-1),t("span",null,"åŸåˆ—æ›¿æ¢å°†ç›´æ¥è¦†ç›–åŸæ•°æ®ï¼Œæ“ä½œä¸å¯æ’¤é”€",-1)])])):M("",!0)])])])):M("",!0)]))}}),At=Ee(Tt,[["__scopeId","data-v-4f25baa6"]]);export{At as default};
